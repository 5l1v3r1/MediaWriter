From 234a91b7095a0213ead470994e5331adc31f1db1 Mon Sep 17 00:00:00 2001
From: squimrel <squimrel@users.noreply.github.com>
Date: Wed, 14 Jun 2017 14:33:44 +0000
Subject: [PATCH 15/28] Add pkgconfig file

---
 CMakeLists.txt     | 16 +++++++++++++---
 README.md          |  4 ++--
 description.txt    |  1 +
 iso9660io.pc.in    | 10 ++++++++++
 scripts/version.sh |  3 +++
 5 files changed, 29 insertions(+), 5 deletions(-)
 create mode 100644 description.txt
 create mode 100644 iso9660io.pc.in
 create mode 100644 scripts/version.sh

diff --git a/CMakeLists.txt b/CMakeLists.txt
index 78ad2f9..268c586 100644
--- a/CMakeLists.txt
+++ b/CMakeLists.txt
@@ -2,8 +2,12 @@ cmake_minimum_required(VERSION 2.6)
 # Don't confuse it with the libcdio-devel which provides a libiso9660.so.
 project(iso9660io)
 
-set (EXPORT_HEADER include/iso9660.h)
-set (PUBLIC_HEADER ${CMAKE_CURRENT_BINARY_DIR}/${CMAKE_PROJECT_NAME}.h)
+execute_process(COMMAND sh ${CMAKE_SOURCE_DIR}/scripts/version.sh
+  OUTPUT_VARIABLE VERSION)
+execute_process(COMMAND cat ${CMAKE_SOURCE_DIR}/description.txt
+  OUTPUT_VARIABLE DESCRIPTION)
+set(EXPORT_HEADER include/iso9660.h)
+set(PUBLIC_HEADER ${CMAKE_CURRENT_BINARY_DIR}/${CMAKE_PROJECT_NAME}.h)
 set(CMAKE_CXX_FLAGS  "${CMAKE_CXX_FLAGS} -std=c++11 -Wall -O3 -DNDEBUG -fvisibility=hidden")
 
 add_custom_command(POST_BUILD
@@ -18,7 +22,7 @@ file(GLOB FILES src/*.cc)
 add_library(${CMAKE_PROJECT_NAME} SHARED ${FILES} ${PUBLIC_HEADER})
 
 set_target_properties(${CMAKE_PROJECT_NAME} PROPERTIES
-  VERSION 0
+  VERSION ${VERSION}
   SOVERSION 0
   PUBLIC_HEADER ${PUBLIC_HEADER})
 
@@ -30,6 +34,12 @@ install(TARGETS ${CMAKE_PROJECT_NAME}
 install(EXPORT ${CMAKE_PROJECT_NAME} DESTINATION share/${CMAKE_PROJECT_NAME}/cmake)
 export(TARGETS ${CMAKE_PROJECT_NAME} FILE ${CMAKE_PROJECT_NAME}.cmake)
 
+configure_file(${CMAKE_PROJECT_NAME}.pc.in
+  ${CMAKE_CURRENT_BINARY_DIR}/${CMAKE_PROJECT_NAME}.pc @ONLY)
+
+install(FILES ${CMAKE_CURRENT_BINARY_DIR}/${CMAKE_PROJECT_NAME}.pc
+  DESTINATION share/pkgconfig)
+
 # Build example.
 add_executable(persistent-storage example/persistent-storage.cc)
 target_link_libraries(persistent-storage ${CMAKE_PROJECT_NAME})
diff --git a/README.md b/README.md
index e707aa9..b3a1780 100644
--- a/README.md
+++ b/README.md
@@ -7,7 +7,7 @@ A basic and incomplete implementation of ECMA-119.
 ```
 mkdir -p build/
 cd build/
-cmake ..
+cmake -DMAKE_INSTALL_PREFIX:PATH=$PWD ..
 make
-sudo make install
+make install
 ```
diff --git a/description.txt b/description.txt
new file mode 100644
index 0000000..5209791
--- /dev/null
+++ b/description.txt
@@ -0,0 +1 @@
+Make tiny modifications to files on an iso image.
diff --git a/iso9660io.pc.in b/iso9660io.pc.in
new file mode 100644
index 0000000..225f043
--- /dev/null
+++ b/iso9660io.pc.in
@@ -0,0 +1,10 @@
+prefix=@CMAKE_INSTALL_PREFIX@
+exec_prefix=@CMAKE_INSTALL_PREFIX@
+includedir=${prefix}/include
+libdir=${exec_prefix}/lib
+
+Name: @CMAKE_PROJECT_NAME@
+Version: @VERSION@
+Description: @DESCRIPTION@
+Cflags: -I${includedir}
+Libs: -L${libdir}
diff --git a/scripts/version.sh b/scripts/version.sh
new file mode 100644
index 0000000..01712e0
--- /dev/null
+++ b/scripts/version.sh
@@ -0,0 +1,3 @@
+#!/bin/sh
+readonly VERSION="$(git describe --abbrev=0 --tags 2>/dev/null || echo 0)"
+echo "${VERSION}" | tr -d "\n"
-- 
2.14.1

